<!DOCTYPE html>
<html>
    <head>
        <title>Space</title>
        <meta charset="utf-8" />
        <style>

html, body, iframe {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    border: none;
    margin: 0;
    padding: 0;
}

        </style>
    </head>
    <body>
        <script src="https://unpkg.com/@babel/standalone"></script>
        <script type="module">

import create, {join, resolve} from 'https://esm.sh/fake-system@0.3.1';
import {showDirectoryPicker} from 'https://unpkg.com/file-system-access@1.0.4/lib/showDirectoryPicker.js';
import dbStorage from 'https://esm.sh/local-db-storage';

let fs = create().fs;
globalThis.fs = fs;

async function addToSystem(dir, startPath) {
    for await (let [name, obj] of dir.entries()) {
        if (name === 'node_modules' || name === '.git') {
            continue;
        }
        let path = join(startPath, name);
        if (obj instanceof FileSystemDirectoryHandle) {
            fs.mkdir(path);
            await addToSystem(obj, path);
        } else {
            fs.write(path, await (await obj.getFile()).text());
        }
    }
}

async function click(event) {
    window.removeEventListener('click', click);
    let dir;
    if (event.shiftKey) {
        event.preventDefault();
        dir = await showDirectoryPicker({id: 'space-game-test'});
        await dbStorage.setItem('space-test-dir', dir);
    } else {
        dir = await dbStorage.getItem('space-test-dir');
    }
    await addToSystem(dir, '/root');
    main();
}

window.addEventListener('click', click);

function read(path) {
    return fs.get(resolve('/root', path)).read();
}

let currentlyLoading;

Babel.registerPlugin('space-test', function() {
    return {
        visitor: {
            ImportStatement(path) {
                let source = path.node.source.value;
                if (!(source.startsWith('.') || source.startsWith('/'))) {
                    source = 'https://esm.sh/' + source;
                } else {
                    let path = normalize(resolve(currentlyLoading.split('/').slice(0, -1).join('/'), source));
                    let oldPath = currentlyLoading;
                    currentlyLoading = path;
                    source = 'data:text/javascript;base64,' + btoa(load(path));
                    currentlyLoading = oldPath;
                }
            }
        }
    }
});

function load(path) {
    let code = read(path);
    currentlyLoading = path;
    return Babel.transform(code, {
        presets: ['typescript', 'space-test'], 
        filename: path.split('/').at(-1),
    }).code;
}

function main() {
    let html = read('src/index.html');
    html = html.replace('<link rel="stylesheet" href="style.css" />', '<style>' + read('src/style.css') + '</style>');
    html = html.replace('<script src="main.js"><' + '/script>'.replace('/', '</'), '<script>' + load('src/index.ts') + '<' + '/script>');
    let iframe = document.createElement('iframe');
    iframe.srcdoc = html;
    document.body.appendChild(iframe);
}

        </script>
    </body>
</html>